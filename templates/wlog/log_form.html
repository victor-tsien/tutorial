<!-- templates/wlog/log_form.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h3 class="mb-0">{{ form_title }}</h3>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="log-form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- 标题选择 -->
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                <strong>{{ form.title.label }}</strong>
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="text-danger small">
                                {% for error in form.title.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">选择所属的周标题</div>
                        </div>
                        
                        <!-- 日期输入 -->
                        <div class="mb-3">
                            <label for="{{ form.created_at.id_for_label }}" class="form-label">
                                <strong>{{ form.created_at.label }}</strong>
                            </label>
                            {{ form.created_at }}
                            {% if form.created_at.errors %}
                            <div class="text-danger small">
                                {% for error in form.created_at.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">日志的日期</div>
                            {{ form.created_at }}
                        </div>
                        
                        <!-- 日志内容 -->
                        <div class="mb-4">
                            <label for="{{ form.log_text.id_for_label }}" class="form-label">
                                <strong>{{ form.log_text.label }}</strong>
                            </label>
                            {{ form.log_text }}
                            {% if form.log_text.errors %}
                            <div class="text-danger small">
                                {% for error in form.log_text.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">写下今天的日志内容</div>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{{ back_url }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> 返回
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <i class="bi bi-check-lg"></i> {{ submit_label }}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 表单样式增强 */
    textarea.form-control {
        min-height: 300px;
        resize: vertical;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    
    select.form-control, 
    input.form-control {
        max-width: 400px;
    }
    
    .card {
        border: 1px solid rgba(0,0,0,.125);
        margin-top: 2rem;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,.125);
        background-color: #f8f9fa;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .form-text {
        margin-top: 0.25rem;
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    /* 错误样式 */
    .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    /* 加载状态 */
    .btn[disabled] {
        cursor: not-allowed;
        opacity: 0.65;
    }
</style>

<script>
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('log-form');
        const submitBtn = document.getElementById('submit-btn');
        const originalBtnText = submitBtn.innerHTML;
        
        // 自动聚焦到第一个错误字段或日志内容
        const firstError = document.querySelector('.is-invalid');
        if (firstError) {
            firstError.focus();
        } else {
            const logTextArea = document.getElementById('{{ form.log_text.id_for_label }}');
            if (logTextArea) {
                logTextArea.focus();
            }
        }
        
        // 处理日期输入字段
        const dateInput = document.getElementById('{{ form.created_at.id_for_label }}');
        if (dateInput) {
            // 如果是文本输入或未指定类型，设置为日期类型
            if (dateInput.type === 'text' || !dateInput.type) {
                dateInput.type = 'date';
            }
            
            // 如果字段为空，设置为今天（但不覆盖已有值）
            if (!dateInput.value) {
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                dateInput.value = formattedDate;
            }
        }
        
        // 表单提交时显示加载状态
        form.addEventListener('submit', function(e) {
            // 保存原始状态
            const wasDisabled = submitBtn.disabled;
            const wasText = submitBtn.innerHTML;
            
            // 设置加载状态
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 提交中...';
            
            // 如果表单验证失败，恢复按钮状态
            if (!form.checkValidity()) {
                setTimeout(() => {
                    submitBtn.disabled = wasDisabled;
                    submitBtn.innerHTML = wasText;
                }, 100);
            }
        });
        
        // 监听表单的invalid事件，防止重复提交
        let isSubmitting = false;
        form.addEventListener('invalid', function(e) {
            if (!isSubmitting) {
                isSubmitting = true;
                setTimeout(() => { isSubmitting = false; }, 1000);
            }
        }, true);
        
        // 表单字段变化时验证
        form.addEventListener('change', function(e) {
            if (e.target.matches('input, textarea, select')) {
                e.target.classList.remove('is-invalid');
            }
        });
        
        // 增强文本区域体验
        const textArea = document.getElementById('{{ form.log_text.id_for_label }}');
        if (textArea) {
            // 添加自动保存提示（可选）
            let saveTimeout;
            textArea.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                // 可以在这里添加自动保存逻辑
            });
            
            // Tab键支持缩进
            textArea.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    
                    // 插入Tab字符
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    
                    // 移动光标位置
                    this.selectionStart = this.selectionEnd = start + 4;
                }
            });
        }
    });
</script>
{% endblock %}